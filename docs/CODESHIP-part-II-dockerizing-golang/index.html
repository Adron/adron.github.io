<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Adron's Composite Code</title>
    <meta name="description" content="">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="Coder, Messenger, Recon, Infrastructure, Ops">
    <link rel="icon" type="image/png" href="/img/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/img/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/favicons/favicon-96x96.png" sizes="96x96">
    <link rel="apple-touch-icon" sizes="57x57" href="/img/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicons/apple-touch-icon-180x180.png">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <script src="/js/modernizr.js"></script>
  </head>
  <body class="article-detail">
    <!--[if lt IE 8]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div class="header header-over large">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-sm-6 col-xs-6">
            <!-- Logo Image--><a href="/index.html" class="logo-image logo-animated"><img src="/img/logos/logo.png" alt="logo"></a>
            <!-- End of Logo Image-->
          </div>
          <div class="col-md-9 col-sm-6 col-xs-6">
            <!-- Menu-->
            <nav class="right helper">
              <ul class="menu sf-menu js-menu">
                <li><a href="/docs/thrashing-code-news/">Thrashing Code News</a></li>
                <li><a href="#">Conf - Meetup - Events</a>
                  <ul>
                    <li><a href="/docs/Speaking-Presentations-Workshops/">Speaking - Presentations - Workshops</a></li>
                    <li><a href="/docs/calendar">Calendar of Engagements</a></li>
                  </ul>
                </li>
                <li><a href="/docs/documentation/">Docs</a></li>
                <li><a href="#">Contact</a>
                  <ul>
                    <li><a href="/docs/contact">Message</a></li>
                    <li><a href="/docs/job-talk/">Hire</a></li>
                  </ul>
                </li>
                <li><a href="/docs/about/">About</a></li>
              </ul>
            </nav>
            <!-- End of Menu-->
          </div>
        </div>
      </div>
    </div>
    <div class="header-back header-back-simple header-back-small">
      <div class="header-back-container">
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <!-- Page Info-->
              <div class="page-info page-info-simple">
                <h1>CODESHIP part II dockerizing golang</h1>
                <div class="nav"> «<a href="/"> Home</a></div>
              </div>
              <!-- End Page Info-->
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="content">
      <div class="container">
        <div class="layout with-right-sidebar js-layout">
          <div class="row">
            <div class="col-md-12">
              <div class="main-content">
                <!-- Blog Page-->
                <docs class="article">
                  <section class="content"><p>Previously in this series I’ve put together all of the basic elements to insure I have a working build to develop from. This insures I have the ability to make changes rapidly, change direction when needed, insure the code base is always building, tested, and able to be deployed. If you want to catch up and follow along step through the previous article of the series <a href="#part1">here</a>.</p>
<p>In this article I’m going to start stepping toward a working services product, and provide a description and details of what I intend to&nbsp;build.</p>
<h2 id="application-description">Application&nbsp;Description</h2>
<p>The idea behind this application is to generate data. However I don’t want to create just a simple data generator alone. Instead I want a system which can generate data and also place it into an appropriate location after generating the data. With this basic setup I would need 2 key pieces of information to pass along to the <span class="caps">API</span>, so that it can then generate the data and put the data into the location&nbsp;designated.</p>
<h2 id="core-application-goals">Core Application&nbsp;Goals</h2>
<ul>
<li>Provide an <span class="caps">API</span> that accepts parameters, via a schema, that then will be used to generate and identify where to put the data after&nbsp;generation.</li>
<li>In the schema, the basic data will describe the structure of the data store in which the generated data will be&nbsp;inserted.</li>
<li>In the schema, I’ll also want to be able to designate the type, and how many of the specific piece of data to&nbsp;generate.</li>
</ul>
<p>I’ve created an example below, to provide an idea of what would be passed into the <span class="caps">API</span>. At this point I’m not trying to determine exactly how something would work, specific criteria, or the details of verifying the data, but just simply a workflow to achieve basic functionality around the core&nbsp;goals.</p>
<pre><code class="lang-javascript">[
  {
    <span class="string">"schema"</span>: <span class="string">"relational"</span>,
    <span class="string">"database"</span>: <span class="string">"postgresql"</span>,
    <span class="string">"connection"</span>: [
      {
        <span class="string">"connectionData"</span>: <span class="string">"stringForConnectionEtc"</span>,
        <span class="string">"username"</span>: <span class="string">"theUser"</span>,
        <span class="string">"password"</span>: <span class="string">"thePassword"</span>,
        <span class="string">"otherConnectionParam"</span>: <span class="string">"TheOtherValue"</span>
      }
    ],
    <span class="string">"structure"</span>: [
      {
        <span class="string">"table"</span>: <span class="string">"Users"</span>,
        <span class="string">"generate"</span>: <span class="string">"4234908"</span>,
        <span class="string">"columns"</span>: [
          {<span class="string">"name"</span>: <span class="string">"id"</span>, <span class="string">"type"</span>: <span class="string">"uuid"</span>},
          {<span class="string">"name"</span>: <span class="string">"firstname"</span>, <span class="string">"type"</span>: <span class="string">"firstname"</span>},
          {<span class="string">"name"</span>: <span class="string">"lastname"</span>, <span class="string">"type"</span>: <span class="string">"lastname"</span>},
          {<span class="string">"name"</span>: <span class="string">"email_address"</span>, <span class="string">"type"</span>: <span class="string">"email"</span>}
        ]
      },
      {
        <span class="string">"table"</span>: <span class="string">"Addresses"</span>,
        <span class="string">"generate"</span>: <span class="string">"2323498"</span>,
        <span class="string">"columns"</span>: [
          {<span class="string">"name"</span>: <span class="string">"id"</span>, <span class="string">"type"</span>: <span class="string">"uuid"</span>},
          {<span class="string">"name"</span>: <span class="string">"userFkId"</span>, <span class="string">"type"</span>: <span class="string">"uuid"</span>, <span class="string">"keyParentTable"</span>: <span class="string">"Users"</span>, <span class="string">"keyParentColumn"</span>: <span class="string">"id"</span>},
          {<span class="string">"name"</span>: <span class="string">"street"</span>, <span class="string">"type"</span>: <span class="string">"address"</span>},
          {<span class="string">"name"</span>: <span class="string">"city"</span>, <span class="string">"type"</span>: <span class="string">"city"</span>},
          {<span class="string">"name"</span>: <span class="string">"state"</span>, <span class="string">"type"</span>: <span class="string">"state"</span>},
          {<span class="string">"name"</span>: <span class="string">"postalcode"</span>, <span class="string">"type"</span>: <span class="string">"zip"</span>}
        ]
      },
      {
        <span class="string">"table"</span>: <span class="string">"Transactions"</span>,
        <span class="string">"generate"</span>: <span class="string">"1432434908"</span>,
        <span class="string">"columns"</span>: [
          { <span class="string">"name"</span>: <span class="string">"id"</span>, <span class="string">"type"</span>: <span class="string">"uuid"</span> },
          {<span class="string">"name"</span>: <span class="string">"userFkId"</span>, <span class="string">"type"</span>: <span class="string">"uuid"</span>, <span class="string">"keyParentTable"</span>: <span class="string">"Users"</span>, <span class="string">"keyParentColumn"</span>: <span class="string">"id"</span>},
          { <span class="string">"name"</span>: <span class="string">"transaction"</span>, <span class="string">"type"</span>: <span class="string">"money"</span> },
          { <span class="string">"name"</span>: <span class="string">"stamp"</span>, <span class="string">"type"</span>: <span class="string">"date"</span> }
        ]
      }
    ]
  }
]
</code></pre>
<p>This example covers the core features. I’ve setup a schema and database key value pair, which I’ve set here to a relational schema setup for a Postgresql relational database. The connection parameter would be an array of key value pairs that would have the necessary information for connecting to the database. Below that the structure is where the database, which will be filled with generated data, is&nbsp;described.</p>
<p>At this point there are many other stories and feature requests I could come up with. At this point I know enough of the story to start building out some more of the systemic elements that are needed. I’ll get right into that and step back into describing features after getting more of a feel for building this <span class="caps">API</span>&nbsp;service.</p>
<h2 id="next-step-dependencies">Next Step&nbsp;Dependencies</h2>
<p>I really need to get into the services at this point. Get something working to actually work from. Similar to how I have already put together the actual build with Codeship Pro. At the end of the last article in this series I had written a <em>hello world</em> style service, but that won’t cut it. For this I want to use something that has features and capabilities focused around a service. This could and should cut back on a lot of the standard work that is needed. For this I’ll use <a href="https://github.com/go-kit/kit">go-kit</a>.</p>
<p>To get this library, I use the standard <a href="https://golang.org/cmd/go/">Go Get</a> command. This command will retrieve an available library for use, creating a dependency within my project. In this case I want to get the go-kit and start using&nbsp;it.</p>
<p><code>go get github.com/go-kit/kit</code></p>
<p>Go-kit focuses on a few key goals. The framework is designed to operate in a heterogenous environment, with the intent to communicate with any and all non go-kit services. <span class="caps">RPC</span> is the primary messaging pattern, it includes pluggable transport and serialization, and is designed to operate with existing&nbsp;infrastructures.</p>
<h2 id="build-some-basic-features">Build Some Basic&nbsp;Features</h2>
<p>I’ll need a service that accepts <span class="caps">JSON</span>, and then can act on that JSON. So the first thing I need to do is to spool up a service with go-kit. To build out this initial business logic I’ll start with an interface. This interface will then have an implementation based on this interface’s&nbsp;contract.</p>
<pre><code>type TellMeAboutJsonService interface {
    TellMeAbout(string) (string, error)
    Elements(string) int
}
</code></pre><p>Next I’ll add a structure&nbsp;variable.</p>
<pre><code>type tellMeAboutJsonService struct{}
</code></pre><p>Now the implementation of the interface for the <code>TellMeAbout</code> and <code>Elements</code> functions.</p>
<pre><code>func (tellMeAboutJsonService) TellMeAbout(s string) (string, error) {
    if s == &quot;&quot; {
        return &quot;&quot;, ErrEmpty
    }

    return s, nil
}

func (tellMeAboutJsonService) Elements(s string) int {
    return len(s)
}
</code></pre><p>Now I’ll need some request and response variable object declarations too. These read like&nbsp;this.</p>
<pre><code>type tellMeAboutRequest struct {
    S string `json:&quot;s&quot;`
}

type tellMeAboutResponse struct {
    V   string `json:&quot;v&quot;`
    Err string `json:&quot;err,omitempty&quot;`
}

type elementsRequest struct {
    S string `json:&quot;s&quot;`
}

type elementsResponse struct {
    V int `json:&quot;v&quot;`
}
</code></pre><p>I’ll also need to be able to decade and encode requests and responses too. Here I’ve added some basic <span class="caps">JSON</span> deoding using the JSON decoder wrapped in some standard error&nbsp;handling.</p>
<pre><code>func decodeTellMeAboutRequest(_ context.Context, r *http.Request) (interface{}, error) {
    var request tellMeAboutRequest
    if err := json.NewDecoder(r.Body).Decode(&amp;request); err != nil {
        return nil, err
    }
    return request, nil
}

func decodeElementsRequest(_ context.Context, r *http.Request) (interface{}, error) {
    var request elementsRequest
    if err := json.NewDecoder(r.Body).Decode(&amp;request); err != nil {
        return nil, err
    }
    return request, nil
}

func encodeResponse(_ context.Context, w http.ResponseWriter, response interface{}) error {
    return json.NewEncoder(w).Encode(response)
}
</code></pre><p>Now I’ll setup the end points. For each go-kit service there is an end point, which basically what will become an access point made available via a <span class="caps">URI</span> that HTTP requests can be made against. For handling JSON that I’ll pass in, as previously described in this article, I’ve setup the <code>makeTellMeAboutEndpoint</code> to handle this processing, and for the <code>makeElementsEndpoint</code> for counting the elements in <span class="caps">JSON</span>. The later isn’t specifically needed immediately, but I can use it to do some simple testing, experimentation, and manipulation of JSON while I work to build this&nbsp;API.</p>
<p>For both of these functions, I’ve writting some extremely basic code just to be able to, at this point, verify that they work. The <code>makeTellMeAboutEndpoint</code> takes the <span class="caps">JSON</span> data and processes it in a basic way, and the elements simply provides a count of characters at this time. Again, just working on insuring a basic working element, and then I can iterate on additional processing of JSON data and such. <em>Small steps, make the bigger bridges&nbsp;possible!</em></p>
<pre><code>func makeTellMeAboutEndpoint(svc TellMeAboutJsonService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(tellMeAboutRequest)
        v, err := svc.TellMeAbout(req.S)
        if err != nil {
            return tellMeAboutResponse{v, err.Error()}, nil
        }
        return tellMeAboutResponse{v, &quot;&quot;}, nil
    }
}

func makeElementsEndpoint(svc TellMeAboutJsonService) endpoint.Endpoint {
    return func(ctx context.Context, request interface{}) (interface{}, error) {
        req := request.(elementsRequest)
        v := svc.Elements(req.S)
        return elementsResponse{v}, nil
    }
}
</code></pre><p>Finally the main&nbsp;function.</p>
<pre><code>func main() {
    svc := tellMeAboutJsonService{}

    tellMeAboutHandler := httptransport.NewServer(
        makeTellMeAboutEndpoint(svc),
        decodeTellMeAboutRequest,
        encodeResponse,
    )

    elementsHandler := httptransport.NewServer(
        makeElementsEndpoint(svc),
        decodeElementsRequest,
        encodeResponse,
    )

    // The URI Endpoints.
    http.Handle(&quot;/tellmeabout&quot;, tellMeAboutHandler)
    http.Handle(&quot;/elements&quot;, elementsHandler)
    log.Fatal(http.ListenAndServe(&quot;:8080&quot;, nil))
}
</code></pre><p>In the main function all these pieces come together. I start by setting variable <code>svc</code> to the interface with <code>svc := tellMeAboutJsonService{}</code>. Next I assign some handlers to deal with the http communication with the various end points I’ll create. This is done with the assignments of <code>tellMeABoutHandler</code> and <code>elementsHandler</code>, which is assigned via a call to <code>NewServer</code> made availble via the <code>httptransport</code> library. Using this function I then pass in the end point with the svc variable interface contract, decade, and encode for each of the specific http servers handling the two endpoints. Finally the two end points are set for the handlers with <code>http.Hanlde(&quot;/uri_path&quot;, handler)</code>. Wrapping up the main method is the call to <code>http.ListenAndServe</code> set to port 8080 and passed into <code>log.Fatal</code> to handle&nbsp;errors.</p>
<p>Now when I run this service, I can execute http calls against the end points with curl. To test this service out I start it by running the service with the basic Go command <em>Run</em>.</p>
<pre><code>go run main.go
</code></pre><p>With that running in one terminal window I can execute http requests against it now. For example I’ll take the above <span class="caps">JSON</span> and send it to the first end point with this&nbsp;command.</p>
<pre><code>curl -XPOST -d&#39;{&quot;s&quot;:&quot;A small sample of JSON data.&quot;}&#39; localhost:8080/tellmeabout
</code></pre><p>The result returns in the terminal with <code>{&quot;v&quot;:&quot;A small sample of JSON data.&quot;}</code>.</p>
<p>Trying that same sample against the count of elements, I get back the character count as&nbsp;expected.</p>
<pre><code>curl -XPOST -d&#39;{&quot;s&quot;:&quot;A small sample of JSON data.&quot;}&#39; localhost:8080/elements
</code></pre><p>The result displays a simple <code>{&quot;v&quot;:28}</code>. Now, the next step is to actually process some more legitimate <span class="caps">JSON</span> that looks more like the configuration example above. However, at this point I’m going to detour and talk about some other development continuous integration&nbsp;process.</p>
<h3 id="the-build-has-broken-">The Build Has&nbsp;Broken!</h3>
<p>If I take a step away from this working code and take a look at the build process, I’ve broken the build with this latest addition of&nbsp;code.</p>
<p><img src="/docs/CODESHIP-part-II-dockerizing-golang/Datadiluvium01d.png" alt="Data Diluvium Broken Build"></p>
<p>Looking at the second step here, where the tests attempt to execute, I’ve found my dependencies aren’t available for the build. This error message allows me to reason and determine the&nbsp;issue:</p>
<ul>
<li>The dependencies are available locally, because I ran the <code>go get github.com/etc...</code> command to retrieve&nbsp;them.</li>
<li>The build process has no step where the dependency is retrieved, and since every build is a brand new container derived from a base image that does not have these dependencies, they’re not&nbsp;available.</li>
<li>I’ll need a step or command to call <code>go get</code> to retrieve these dependencies for the&nbsp;build.</li>
<li>I may want to determine another dependency management solution for the project if I move beyond a single dependency like&nbsp;this.</li>
</ul>
<p>That last point, is important since any reasonably sized Go project will end up with dozens, sometimes many dozens of dependencies. Managing which dependencies are executed where; locally, for the build, in dev, or production environments, could become very cumbersome. This is where vendoring and a dependency management tool like Glide comes in&nbsp;handy!</p>
<h2 id="back-to-dependencies-implementing-glide">Back to Dependencies, Implementing&nbsp;Glide</h2>
<p>Glide is described on its <span class="caps">README</span>.md&nbsp;as</p>
<blockquote>
<p>“Are you used to tools such as Cargo, npm, Composer, Nuget, Pip, Maven, Bundler, or other modern package managers? If so, Glide is the comparable Go&nbsp;tool.”</p>
</blockquote>
<p>Basically, it’s a Go vendor and vendored package management tool. In Go, there is a feature around keeping dependencies in a directory, called <em>vendor</em> that stores the various dependencies for a&nbsp;project.</p>
<p>Since the build has broken, and brought the issue of dependencies to the forefront of concern at the moment, I’m going to wrap up this installment of this series by installing Glide and adding the go-kit&nbsp;dependencies.</p>
<h3 id="installing-glide">Installing&nbsp;Glide</h3>
<p><img src="/docs/CODESHIP-part-II-dockerizing-golang/glide.png" alt="Glide Logo"></p>
<p>The easiest way to install glide is to install it with brew on the Mac or with apt-get on Linux. The command for <span class="caps">OS</span>-X is simply <code>brew install glide</code>. With Linux, the repository needs added first, then glide can be&nbsp;installed.</p>
<pre><code>sudo add-apt-repository ppa:masterminds/glide &amp;&amp; sudo apt-get update
sudo apt-get install glide
</code></pre><p>There are also binary packages if you would like to go that route, available <a href="https://github.com/Masterminds/glide/releases">here</a>. If you’d like to build your own binaries specifically for your system, that’s also an option. I’ll leave that path up to you to tackle via the Glide Project’s <a href="https://github.com/Masterminds/glide"><span class="caps">README</span>.md</a>.</p>
<p>Once installed just typing <code>glide</code> will print out the available commands in the terminal, showing it has been installed properly. The next step after installation is to setup the project with Glide. To do so, issue the command <code>glide create</code>. When issuing the command, glide will then prompt to setup the appropriate configuration for the project and any other questions it needs&nbsp;answered.</p>
<p><img src="/docs/CODESHIP-part-II-dockerizing-golang/glide-create.png" alt="Glide Create"></p>
<p>Next I’ll need to verify what the create process did, so I’ll open up the newly created <code>glide.yaml</code> file. The contents, since the glide command scans through the project it is run within, looks like&nbsp;this.</p>
<pre><code>package: github.com/adron/datadiluvium-02
import:
- package: github.com/go-kit/kit
  version: ~0.4.0
  subpackages:
  - endpoint
  - transport/http
</code></pre><p>The core package is go-kit or github.com/go-kit/kit while the two specific subpackages I’m using, are <em>endpoint</em> and <em>transport/http</em>.</p>
<p>Next steps 1. add glide to the dockerfile so it is available on the image…
step 2. update the steps yaml for the codeship file.
step&nbsp;3. </p>
</section>
                </docs>
                <!-- End of Blog Page-->
              </div>
            </div>
          </div>
        </div>
        <div class="nav"><a href="/">« Home</a></div>
      </div>
    </div>
    <script src="/js/all.js"></script>
    <script src="/js/custom.js"></script>
    <!-- Google Tag Manager-->
    <noscript>
      <iframe src="//www.googletagmanager.com/ns.html?id=GTM-KMMZX2" height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <script>
      console.log(document.getElementById("search-google"));
      console.log(document.getElementById("search-google").innerText);
      
      var searchBox = document.getElementById("search-google");
      
      function googleSearch(search_string) {
          alert(search_string);
      }
      
      document.getElementById("search-google").addEventListener("onClick", function () {
          alert(document.getElementById("search-google").innerHTML);
      });
      
      document.getElementById("search-google").addEventListener("onClick", function () {
          googleSearch(document.getElementById("search-google").innerHTML)
      });
      
    </script>
    <script>
      (function (i, s, o, g, r, a, m) {
          i['GoogleAnalyticsObject'] = r;
          i[r] = i[r] || function () {
                      (i[r].q = i[r].q || []).push(arguments)
                  }, i[r].l = 1 * new Date();
          a = s.createElement(o),
                  m = s.getElementsByTagName(o)[0];
          a.async = 1;
          a.src = g;
          m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
      ga('create', 'UA-39158070-6', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>